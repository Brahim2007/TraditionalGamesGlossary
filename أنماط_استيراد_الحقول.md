# الأنماط العامة لاستيراد الحقول من النص

## 1. النمط العام للتعرف على الحقول (Regex Pattern)

```javascript
const regex = new RegExp(
  `^[\\-•*]?\\s*${pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(\\s*\\(.*?\\))?\\s*[:\\-–\\/\\t,،]*\\s*`, 
  'i'
);
```

### شرح النمط:
- `^` - بداية السطر
- `[\\-•*]?` - اختياري: رمز قائمة (-, •, *)
- `\\s*` - مسافات اختيارية
- `${pattern}` - النمط المطلوب (مع escape للأحرف الخاصة)
- `(\\s*\\(.*?\\))?` - اختياري: نص بين قوسين مثل "(تفاصيل)"
- `\\s*` - مسافات اختيارية
- `[:\\-–\\/\\t,،]*` - اختياري: فاصل (:, -, –, /, tab, comma, فاصلة عربية)
- `\\s*` - مسافات اختيارية
- `i` - case insensitive (غير حساس لحالة الأحرف)

---

## 2. خريطة الحقول والأنماط (Field Mappings)

### الحقول الأساسية:
```javascript
{ key: 'name', patterns: ['اسم اللعبة', 'الاسم الرسمي', 'اسم اللعبة الرسمي'] }
{ key: 'localNames', patterns: ['المسميات المحلية', 'بديلة', 'أسماء أخرى'] }
{ key: 'country', patterns: ['الدولة'] }
{ key: 'region', patterns: ['الإقليم', 'نطاق الانتشار'] }
{ key: 'heritageField', patterns: ['مجال التراث'] }
{ key: 'tags', patterns: ['تاجات التصنيف', 'الوسوم', 'نوع اللعبة'] }
```

### الحقول الوصفية:
```javascript
{ key: 'description', patterns: ['الوصف الموسع', 'شرح اللعبة', 'نبذة'] }
```

### الحقول العمرية واللاعبين:
```javascript
{ key: 'ageGroup', patterns: ['الفئة العمرية'] }
{ key: 'ageGroupDetails', patterns: ['وصف الفئة العمرية', 'الفئة العمرية (تفاصيل)'] }
{ key: 'practitioners', patterns: ['الممارسون', 'نوع الممارسين'] }
{ key: 'practitionersDetails', patterns: ['وصف الممارسين', 'نوع الممارسين (تفاصيل)'] }
{ key: 'players', patterns: ['عدد اللاعبين'] }
{ key: 'playersDetails', patterns: ['وصف اللاعبين', 'عدد اللاعبين (تفاصيل)'] }
```

### الحقول اللوجستية:
```javascript
{ key: 'tools', patterns: ['الأدوات', 'الأدوات والمستلزمات'] }
{ key: 'environment', patterns: ['بيئة الممارسة', 'المكان'] }
{ key: 'timing', patterns: ['التوقيت', 'الزمان', 'الوقت'] }
```

### الحقول المتعلقة بالقواعد:
```javascript
{ key: 'rules', patterns: ['قواعد اللعب', 'طريقة اللعب'] }
{ key: 'winLoss', patterns: ['نظام الفوز والخسارة', 'الفوز والخسارة'] }
{ key: 'startEnd', patterns: ['آلية البدء والانتهاء', 'البدء والانتهاء'] }
```

### الحقول التراثية:
```javascript
{ key: 'oralTradition', patterns: ['الموروث الشفهي', 'أهازيج', 'أهازيج ومصطلحات'] }
{ key: 'socialContext', patterns: ['السياق الاجتماعي', 'القيم الاجتماعية'] }
{ key: 'references', patterns: ['المراجع', 'المصادر والمراجع', 'المصادر', 'قائمة المراجع'] }
```

---

## 3. خريطة توحيد أسماء الدول (Country Normalization Map)

```javascript
const countryMap = {
  "السعودية": "المملكة العربية السعودية",
  "قطر": "دولة قطر",
  "الإمارات": "الإمارات العربية المتحدة",
  "الامارات": "الإمارات العربية المتحدة", // بدون همزة
  "الكويت": "دولة الكويت",
  "عمان": "سلطنة عمان",
  "عُمان": "سلطنة عمان",
  "البحرين": "مملكة البحرين",
  "الأردن": "المملكة الأردنية الهاشمية",
  "الاردن": "المملكة الأردنية الهاشمية", // بدون همزة
  "مصر": "جمهورية مصر العربية",
  "اليمن": "الجمهورية اليمنية",
  "العراق": "جمهورية العراق",
  "تونس": "الجمهورية التونسية",
  "الجزائر": "الجمهورية الجزائرية",
  "المغرب": "المملكة المغربية",
  "السودان": "جمهورية السودان",
  "ليبيا": "دولة ليبيا",
  "فلسطين": "دولة فلسطين",
  "لبنان": "الجمهورية اللبنانية",
  "سوريا": "الجمهورية العربية السورية",
  "موريتانيا": "الجمهورية الإسلامية الموريتانية",
  "جيبوتي": "جمهورية جيبوتي",
  "جزر القمر": "جزر القمر",
  "القمر": "جزر القمر",
  "الصومال": "جمهورية الصومال"
};
```

---

## 4. المنطق الخاص بالحقول

### أ. حقل القواعد (Rules):
- يتم جمع جميع الأسطر التالية لحقل "قواعد اللعب" في buffer
- يتم إزالة الأرقام والرموز من بداية كل سطر: `(\d+[\.\-\)\s]+|[•\-\*])\s*`
- يتم تصفية الأسطر الفارغة
- النتيجة: مصفوفة من القواعد

### ب. حقل الدولة (Country):
- يتم البحث في `countryMap` عن تطابق جزئي
- إذا وُجد تطابق، يتم استخدام الاسم الموحد
- إذا لم يُوجد، يتم استخدام النص الأصلي

### ج. باقي الحقول:
- يتم إضافة المحتوى مباشرة
- إذا كان الحقل يحتوي على نص سابق، يتم إضافة سطر جديد (`\n`)

---

## 5. أمثلة على النصوص المدعومة

### مثال 1: تنسيق بسيط
```
اسم اللعبة: الركض بالحاجبين
الدولة: قطر
عدد اللاعبين: 4
```

### مثال 2: مع رموز قائمة
```
- اسم اللعبة: الركض بالحاجبين
• الدولة: قطر
* عدد اللاعبين: 4
```

### مثال 3: مع أقواس
```
اسم اللعبة (الرسمي): الركض بالحاجبين
الفئة العمرية (تفاصيل): من 8 إلى 12 سنة
```

### مثال 4: مع فواصل مختلفة
```
اسم اللعبة: الركض بالحاجبين
الدولة - قطر
عدد اللاعبين، 4
```

### مثال 5: قواعد متعددة الأسطر
```
قواعد اللعب:
1. يقف اللاعبون في صف
2. يبدأ اللاعب الأول بالركض
3. يجب الحفاظ على التوازن
```

---

## 6. الخوارزمية العامة

```
1. تقسيم النص إلى أسطر (split by \r?\n)
2. لكل سطر:
   a. إزالة المسافات الزائدة (trim)
   b. تخطي الأسطر الفارغة
   c. محاولة مطابقة السطر مع أحد الأنماط
   d. إذا وُجد تطابق:
      - تحديد الحقل الحالي (currentKey)
      - استخراج المحتوى (بعد إزالة النمط)
      - تطبيق منطق خاص للحقل (country, rules)
   e. إذا لم يُوجد تطابق وكان هناك حقل حالي:
      - إضافة السطر إلى الحقل الحالي
3. معالجة نهائية:
   - تنظيف قواعد اللعب (إزالة الأرقام والرموز)
   - تطبيق التغييرات على البيانات
```

---

## 7. ملاحظات مهمة

1. **الحساسية لحالة الأحرف**: النمط غير حساس لحالة الأحرف (case insensitive)
2. **المرونة في الفواصل**: يدعم عدة أنواع من الفواصل (:, -, –, /, tab, comma, فاصلة عربية)
3. **دعم رموز القوائم**: يدعم رموز القوائم (-, •, *)
4. **دعم الأقواس**: يمكن أن يحتوي اسم الحقل على نص إضافي بين قوسين
5. **دعم النصوص متعددة الأسطر**: يمكن أن يمتد محتوى الحقل لعدة أسطر
6. **توحيد أسماء الدول**: يتم توحيد أسماء الدول تلقائياً

---

## 8. كيفية إضافة حقل جديد

لإضافة حقل جديد، قم بإضافته إلى `fieldMappings`:

```javascript
{ key: 'newField', patterns: ['اسم الحقل بالعربية', 'اسم بديل', 'اسم ثالث'] }
```

**ملاحظة**: لا حاجة لتعديل النمط (regex) - سيتم تطبيقه تلقائياً على جميع الأنماط.
